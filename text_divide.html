<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TXT æ–‡ä»¶åˆ†å‰²å·¥å…·</title>
    <!-- å¼•å…¥ JSZip åº“ç”¨äºæ‰“åŒ…ä¸‹è½½ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --surface-color: #ffffff;
            --text-color: #333;
            --border-color: #dee2e6;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --font-family: 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background-color: var(--surface-color);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            text-align: center;
        }

        header h1 {
            color: var(--primary-color);
            font-size: 2em;
            margin-bottom: 10px;
        }

        header p {
            color: var(--secondary-color);
            font-size: 1.1em;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .upload-area {
            border: 2px dashed var(--primary-color);
            border-radius: 10px;
            padding: 40px;
            margin-bottom: 20px;
            background-color: #f0f8ff;
            transition: background-color 0.3s, border-color 0.3s;
            cursor: pointer;
        }

        .upload-area.dragover {
            background-color: #e0f0ff;
            border-color: #0056b3;
        }

        .upload-area-icon {
            font-size: 3em;
            color: var(--primary-color);
        }

        .upload-area-text {
            margin-top: 15px;
            font-size: 1.2em;
            color: var(--secondary-color);
        }

        .button {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            display: inline-block;
            text-decoration: none;
            margin: 5px;
        }

        .button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .button.secondary {
            background-color: var(--success-color);
        }
        
        .button.secondary:hover {
            background-color: #218838;
        }

        #file-input {
            display: none;
        }

        .separator {
            border: 0;
            height: 1px;
            background: var(--border-color);
            margin: 40px 0;
        }
        
        #example-content {
            display: none;
            margin-top: 20px;
            text-align: left;
            transition: all 0.5s ease-in-out;
        }
        
        .data-layout { /* æ”¹ä¸ºé€šç”¨ç±»å */
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .data-column .table-container + .table-container { /* æ”¹ä¸ºé€šç”¨ç±»å */
             margin-top: 20px;
        }
        
        .table-container {
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: left;
        }
        
        .table-container h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--secondary-color);
            font-size: 1.1em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed; /* ç¡®ä¿è¡¨æ ¼éµå®ˆå®¹å™¨å®½åº¦ */
        }

        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: normal; /* å…è®¸æ–‡æœ¬æ¢è¡Œ */
            word-wrap: break-word; /* å¼ºåˆ¶é•¿å•è¯æ¢è¡Œ */
        }

        thead th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--primary-color);
        }

        tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tbody tr:hover {
            background-color: #e9ecef;
        }

        footer {
            margin-top: 40px;
            font-size: 0.9em;
            color: #adb5bd;
        }

        #preview-section {
            text-align: left;
            margin-top: 20px;
        }

        #preview-section h2 {
            text-align: center;
            color: var(--primary-color);
        }
        
        #preview-container {
            margin-top: 20px;
        }

        #download-zip-button {
            display: block;
            margin: 10px auto 20px;
        }
        
        @media (max-width: 768px) {
            .data-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>TXT æ–‡ä»¶åˆ†å‰²å·¥å…· ğŸ“‚</h1>
            <p>æœ¬ç¨‹åºæ ¹æ® TXT æ–‡ä»¶ç¬¬ä¸€åˆ—çš„æ ‡è¯†ï¼ˆ0 æˆ– 1ï¼‰è¿›è¡Œåˆ†å‰²ã€‚<br>å®ƒä¼šå°†æ ‡è¯†è¿ç»­ä¸º <strong>1</strong> çš„è¡Œæå–å¹¶è¾“å‡ºä¸ºæ–°çš„ TXT æ–‡ä»¶ï¼ŒåŒæ—¶å¿½ç•¥æ ‡è¯†ä¸º <strong>0</strong> çš„è¡Œã€‚</p>
        </header>

        <div id="upload-area" class="upload-area">
            <div class="upload-area-icon">â¬†ï¸</div>
            <div class="upload-area-text">å°† TXT æ–‡ä»¶æ‹–æ‹½åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
        </div>

        <button id="select-file-button" class="button">é€‰æ‹©æ–‡ä»¶</button>
        <input type="file" id="file-input" accept=".txt">

        <div id="preview-section" style="display: none;">
            <hr class="separator">
            <h2>æå–ç»“æœé¢„è§ˆ</h2>
            <button id="download-zip-button" class="button secondary">æ‰“åŒ…ä¸‹è½½ (.zip)</button>
            <div id="preview-container"></div>
        </div>
        
        <hr class="separator">

        <button id="toggle-example-button" class="button">ç‚¹å‡»å±•å¼€ä½¿ç”¨ç¤ºä¾‹</button>
        
        <div id="example-content">
             <div class="data-layout">
                <!-- å·¦ä¾§ -->
                <div class="data-column">
                    <div class="table-container">
                        <h3>åŸå§‹ TXT (Input.txt)</h3>
                        <table>
                            <thead>
                                <tr><th>æ ‡è¯†</th><th>æ¡©å·</th><th>è®¾è®¡æ°´ä½</th><th>å ¤é¡¶é«˜</th><th>å ¤è„šé«˜</th></tr>
                            </thead>
                            <tbody>
                                <tr><td>0</td><td>K2+063</td><td>121.30</td><td></td><td></td></tr>
                                <tr><td>0</td><td>K2+200</td><td>121.31</td><td></td><td></td></tr>
                                <tr><td>1</td><td>K2+230</td><td>121.32</td><td>108.97</td><td>107.17</td></tr>
                                <tr><td>1</td><td>K2+278</td><td>121.32</td><td>109.94</td><td>108.16</td></tr>
                                <tr><td>1</td><td>K2+325</td><td>121.32</td><td>109.74</td><td>107.94</td></tr>
                                <tr><td>0</td><td>K3+186</td><td>121.37</td><td></td><td></td></tr>
                                <tr><td>0</td><td>K3+200</td><td>121.37</td><td></td><td></td></tr>
                                <tr><td>0</td><td>K3+400</td><td>121.38</td><td></td><td></td></tr>
                                <tr><td>1</td><td>K3+414</td><td>121.38</td><td>110.26</td><td>108.46</td></tr>
                                <tr><td>1</td><td>K3+460</td><td>121.38</td><td>109.64</td><td>107.84</td></tr>
                                <tr><td>1</td><td>K3+509</td><td>121.39</td><td>110.84</td><td>109.04</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- å³ä¾§ -->
                <div class="data-column">
                    <div class="table-container">
                        <h3>è¾“å‡ºæ–‡ä»¶ 1 (K2+230-K2+325.txt)</h3>
                        <table>
                            <thead>
                                <tr><th>æ¡©å·</th><th>è®¾è®¡æ°´ä½</th><th>å ¤é¡¶é«˜</th><th>å ¤è„šé«˜</th></tr>
                            </thead>
                            <tbody>
                                <tr><td>K2+230</td><td>121.32</td><td>108.97</td><td>107.17</td></tr>
                                <tr><td>K2+278</td><td>121.32</td><td>109.94</td><td>108.16</td></tr>
                                <tr><td>K2+325</td><td>121.32</td><td>109.74</td><td>107.94</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="table-container">
                        <h3>è¾“å‡ºæ–‡ä»¶ 2 (K3+414-K3+509.txt)</h3>
                        <table>
                            <thead>
                                <tr><th>æ¡©å·</th><th>è®¾è®¡æ°´ä½</th><th>å ¤é¡¶é«˜</th><th>å ¤è„šé«˜</th></tr>
                            </thead>
                            <tbody>
                                <tr><td>K3+414</td><td>121.38</td><td>110.26</td><td>108.46</td></tr>
                                <tr><td>K3+460</td><td>121.38</td><td>109.64</td><td>107.84</td></tr>
                                <tr><td>K3+509</td><td>121.39</td><td>110.84</td><td>109.04</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>æ‰€æœ‰æ–‡ä»¶å¤„ç†å‡åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°å®Œæˆï¼Œæ•°æ®ä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨ã€‚</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // å…¨å±€å˜é‡ï¼Œç”¨äºå­˜å‚¨æ–‡ä»¶ä¿¡æ¯
            let generatedFiles = [];
            let originalFileData = null;
            let originalFileName = 'output';

            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');
            const selectFileButton = document.getElementById('select-file-button');
            const toggleExampleButton = document.getElementById('toggle-example-button');
            const exampleContent = document.getElementById('example-content');
            const previewSection = document.getElementById('preview-section');
            const previewContainer = document.getElementById('preview-container');
            const downloadZipButton = document.getElementById('download-zip-button');

            // --- äº‹ä»¶ç›‘å¬ ---
            selectFileButton.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    originalFileName = file.name.replace(/\.txt$/i, '');
                    processFile(file);
                }
            });
            
            toggleExampleButton.addEventListener('click', () => {
                const isHidden = exampleContent.style.display === 'none' || exampleContent.style.display === '';
                exampleContent.style.display = isHidden ? 'block' : 'none';
                toggleExampleButton.textContent = isHidden ? 'ç‚¹å‡»æŠ˜å ä½¿ç”¨ç¤ºä¾‹' : 'ç‚¹å‡»å±•å¼€ä½¿ç”¨ç¤ºä¾‹';
            });

            downloadZipButton.addEventListener('click', packageAndDownload);

            // --- æ‹–æ‹½å¤„ç† ---
            ['dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

            uploadArea.addEventListener('dragover', () => uploadArea.classList.add('dragover'));
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));

            uploadArea.addEventListener('drop', (e) => {
                uploadArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.type === "text/plain") {
                    originalFileName = file.name.replace(/\.txt$/i, '');
                    processFile(file);
                } else {
                    alert("è¯·æ‹–æ‹½ä¸€ä¸ªæœ‰æ•ˆçš„ .txt æ–‡ä»¶ã€‚");
                }
            });

            // --- æ ¸å¿ƒé€»è¾‘ ---
            function processFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => processAndPreview(e.target.result);
                reader.onerror = () => alert("æ— æ³•è¯»å–æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æƒé™æˆ–é‡è¯•ã€‚");
                reader.readAsText(file, 'UTF-8');
            }

            function processAndPreview(fileContent) {
                generatedFiles = [];
                originalFileData = null;
                previewContainer.innerHTML = '';
                previewSection.style.display = 'none';

                const lines = fileContent.split(/\r?\n/).filter(line => line.trim() !== '');
                if (lines.length < 2) {
                    alert("æ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®ï¼ˆè‡³å°‘éœ€è¦è¡¨å¤´å’Œä¸€è¡Œæ•°æ®ï¼‰ã€‚");
                    return;
                }

                const originalHeader = lines[0].split('\t');
                const originalRows = lines.slice(1).map(line => line.split('\t'));
                originalFileData = { header: originalHeader, rows: originalRows };

                const headerForOutput = originalHeader.slice(1);
                
                let tempBlock = [];
                const outputBlocks = [];

                originalRows.forEach(columns => {
                    if (columns.length > 0) {
                        if (columns[0].trim() === '1') {
                            tempBlock.push(columns.slice(1));
                        } else if (columns[0].trim() === '0' && tempBlock.length > 0) {
                            outputBlocks.push(tempBlock);
                            tempBlock = [];
                        }
                    }
                });
                
                if (tempBlock.length > 0) outputBlocks.push(tempBlock);

                if (outputBlocks.length === 0) {
                    alert("æœªæ‰¾åˆ°æ ‡è¯†ä¸º '1' çš„æœ‰æ•ˆæ•°æ®è¡Œã€‚");
                    return;
                }

                outputBlocks.forEach(block => {
                    const fileName = `${block[0][0]}-${block[block.length - 1][0]}.txt`;
                    const fileBody = block.map(row => row.join('\t')).join('\n');
                    const newFileContent = headerForOutput.join('\t') + '\n' + fileBody;
                    generatedFiles.push({ name: fileName, content: newFileContent, header: headerForOutput, rows: block });
                });

                displayPreviews();
                previewSection.style.display = 'block';
            }

            function createTable(headerTexts, rowsData) {
                const table = document.createElement('table');
                const thead = document.createElement('thead');
                const tbody = document.createElement('tbody');
                
                const headerRow = document.createElement('tr');
                headerTexts.forEach(text => {
                    const th = document.createElement('th');
                    th.textContent = text;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);

                rowsData.forEach(rowData => {
                    const tr = document.createElement('tr');
                    rowData.forEach(cellData => {
                        const td = document.createElement('td');
                        td.textContent = cellData;
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });

                table.appendChild(thead);
                table.appendChild(tbody);
                return table;
            }

            function displayPreviews() {
                previewContainer.innerHTML = ''; 
                
                const layoutDiv = document.createElement('div');
                layoutDiv.className = 'data-layout';
                
                // å·¦ä¾§: åŸå§‹æ–‡ä»¶é¢„è§ˆ
                const leftColumn = document.createElement('div');
                leftColumn.className = 'data-column';
                if (originalFileData) {
                    const tableContainer = document.createElement('div');
                    tableContainer.className = 'table-container';
                    const title = document.createElement('h3');
                    title.textContent = `åŸå§‹æ–‡ä»¶ (${originalFileName}.txt)`;
                    const table = createTable(originalFileData.header, originalFileData.rows);
                    tableContainer.appendChild(title);
                    tableContainer.appendChild(table);
                    leftColumn.appendChild(tableContainer);
                }
                
                // å³ä¾§: è¾“å‡ºæ–‡ä»¶é¢„è§ˆ
                const rightColumn = document.createElement('div');
                rightColumn.className = 'data-column';
                generatedFiles.forEach(file => {
                    const tableContainer = document.createElement('div');
                    tableContainer.className = 'table-container';
                    const title = document.createElement('h3');
                    title.textContent = `è¾“å‡º: ${file.name}`;
                    const table = createTable(file.header, file.rows);
                    tableContainer.appendChild(title);
                    tableContainer.appendChild(table);
                    rightColumn.appendChild(tableContainer);
                });

                layoutDiv.appendChild(leftColumn);
                layoutDiv.appendChild(rightColumn);
                previewContainer.appendChild(layoutDiv);
            }

            function packageAndDownload() {
                if (generatedFiles.length === 0) {
                    alert("æ²¡æœ‰å¯ä¾›ä¸‹è½½çš„æ–‡ä»¶ã€‚");
                    return;
                }
                const zip = new JSZip();
                generatedFiles.forEach(file => zip.file(file.name, file.content));

                zip.generateAsync({ type: 'blob' })
                    .then(blob => triggerDownload(`${originalFileName}_åˆ†å‰²ç»“æœ.zip`, blob))
                    .catch(err => {
                        console.error("å‹ç¼©æ–‡ä»¶æ—¶å‡ºé”™:", err);
                        alert("åˆ›å»º .zip æ–‡ä»¶å¤±è´¥ã€‚");
                    });
            }

            function triggerDownload(filename, blob) {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            }
        });
    </script>
</body>
</html>
